# PHP
# Test and package your PHP project.
# Add steps that run tests, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/php

trigger:
  branches:
    include:
      - developer
      - main

pool:
  vmImage: 'ubuntu-20.04'

variables:
  PHP_VERSION: 7.4
  NODE_VERSION: 14
  MYSQL_VERSION: 5.7

steps:
  - script: |
      sudo apt-get update
      sudo apt-get install -y software-properties-common
      sudo add-apt-repository -y ppa:ondrej/php
      sudo apt-get update
      sudo apt-get remove -y php*
      sudo apt-get install -y php7.4 php7.4-cli php7.4-mbstring php7.4-xml php7.4-bcmath php7.4-curl php7.4-zip unzip
      sudo update-alternatives --set php /usr/bin/php7.4
      php -v
    displayName: 'üîß Instalar y forzar PHP 7.4'

  - script: |
      curl -sS https://getcomposer.org/installer | php
      sudo mv composer.phar /usr/local/bin/composer
      composer --version
    displayName: '‚öôÔ∏è Instalar Composer'

  - script: |
      composer install --ignore-platform-reqs --no-interaction --prefer-dist
    displayName: 'üì¶ Instalar dependencias de Laravel'

  - script: |
      cp .env.example .env
      php artisan key:generate
    displayName: 'Configurar entorno de Laravel'

  - script: |
      php artisan migrate --force
    displayName: 'Ejecutar migraciones de MySQL'

  - script: |
      php artisan config:cache
      php artisan route:cache
      php artisan view:cache
    displayName: 'Optimizar configuraci√≥n de Laravel'

  - script: |
      npm install
      npm run prod
    displayName: 'Instalar dependencias Frontend'

  - script: |
      php artisan test
    displayName: 'Ejecutar pruebas de Laravel'

  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: '$(Build.SourcesDirectory)'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/deploy.zip'

  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: '$(Build.ArtifactStagingDirectory)/deploy.zip'
      artifactName: 'drop'
